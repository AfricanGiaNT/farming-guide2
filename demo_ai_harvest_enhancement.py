#!/usr/bin/env python3
"""
Demo AI-Enhanced Harvest Advisor - Phase 6
Demonstrates the AI-enhanced harvest advisor with mock AI responses
"""

import asyncio
import sys
import os

# Add project root to path
project_root = os.path.dirname(os.path.abspath(__file__))
sys.path.insert(0, project_root)

from scripts.handlers.harvest_advisor import HarvestAdvisor
from scripts.handlers.harvest_handler import HarvestHandler
from scripts.utils.logger import logger


class MockAIHarvestAdvisor(HarvestAdvisor):
    """Mock version of HarvestAdvisor that uses predefined AI responses."""
    
    def __init__(self):
        """Initialize with mock AI responses."""
        super().__init__()
        self.mock_ai_responses = {
            'maize': {
                'raw_response': """
                Risk Assessment:
                ‚Ä¢ Weather risks: Medium - monitor for late rains during harvest
                ‚Ä¢ Storage risks: Low - ensure proper drying before storage
                ‚Ä¢ Quality risks: Medium - handle carefully to prevent damage
                
                Timing Optimization:
                ‚Ä¢ Harvest when kernels are hard and dry (20-25% moisture)
                ‚Ä¢ Avoid harvesting during rainy periods
                ‚Ä¢ Complete harvest within 2-3 weeks of maturity
                
                Quality Enhancement:
                ‚Ä¢ Use clean, dry containers for collection
                ‚Ä¢ Remove damaged or diseased ears immediately
                ‚Ä¢ Sort by size and quality for better market value
                
                Market Timing:
                ‚Ä¢ Sell early harvest for premium prices
                ‚Ä¢ Store surplus for off-season sales
                ‚Ä¢ Monitor local market prices weekly
                
                Resource Optimization:
                ‚Ä¢ Use family labor efficiently during peak harvest
                ‚Ä¢ Invest in basic drying equipment for quality
                ‚Ä¢ Plan storage space based on expected yield
                """,
                'personalized_recommendations': [
                    "Check maize moisture content daily before harvest",
                    "Prepare drying area with raised platforms",
                    "Organize storage containers by harvest date"
                ]
            },
            'beans': {
                'raw_response': """
                Risk Assessment:
                ‚Ä¢ Weather risks: High - beans are sensitive to moisture
                ‚Ä¢ Storage risks: High - prone to fungal growth
                ‚Ä¢ Quality risks: Medium - handle gently to prevent bruising
                
                Timing Optimization:
                ‚Ä¢ Harvest when pods are dry and brown
                ‚Ä¢ Avoid harvesting when dew is present
                ‚Ä¢ Complete harvest in morning hours
                
                Quality Enhancement:
                ‚Ä¢ Thresh carefully to avoid seed damage
                ‚Ä¢ Clean thoroughly to remove debris
                ‚Ä¢ Grade by size and color for better prices
                
                Market Timing:
                ‚Ä¢ Sell fresh beans immediately after harvest
                ‚Ä¢ Store dried beans in airtight containers
                ‚Ä¢ Target local markets for best prices
                
                Resource Optimization:
                ‚Ä¢ Use manual threshing for small plots
                ‚Ä¢ Invest in moisture meters for quality control
                ‚Ä¢ Plan harvest timing with family availability
                """,
                'personalized_recommendations': [
                    "Harvest beans only when pods are completely dry",
                    "Use clean tarps for threshing to maintain quality",
                    "Store in cool, dry location with good ventilation"
                ]
            },
            'groundnuts': {
                'raw_response': """
                Risk Assessment:
                ‚Ä¢ Weather risks: Medium - avoid harvesting in wet soil
                ‚Ä¢ Storage risks: High - very prone to aflatoxin
                ‚Ä¢ Quality risks: High - handle with extreme care
                
                Timing Optimization:
                ‚Ä¢ Harvest when leaves turn yellow and dry
                ‚Ä¢ Ensure soil is dry before digging
                ‚Ä¢ Complete harvest before heavy rains
                
                Quality Enhancement:
                ‚Ä¢ Dig carefully to avoid damaging pods
                ‚Ä¢ Dry immediately after harvest
                ‚Ä¢ Sort and remove damaged pods
                
                Market Timing:
                ‚Ä¢ Sell fresh groundnuts for immediate consumption
                ‚Ä¢ Process into oil or paste for value addition
                ‚Ä¢ Store properly to prevent aflatoxin contamination
                
                Resource Optimization:
                ‚Ä¢ Use family labor for careful harvesting
                ‚Ä¢ Invest in proper drying racks
                ‚Ä¢ Plan processing for value addition
                """,
                'personalized_recommendations': [
                    "Test soil moisture before starting harvest",
                    "Use wooden tools to avoid pod damage",
                    "Dry groundnuts on raised platforms immediately"
                ]
            }
        }
    
    async def _get_ai_response(self, prompt: str, user_id: str) -> str:
        """Return mock AI response based on crop."""
        # Extract crop from prompt
        crop = None
        for test_crop in ['maize', 'beans', 'groundnuts']:
            if test_crop in prompt.lower():
                crop = test_crop
                break
        
        if crop and crop in self.mock_ai_responses:
            return self.mock_ai_responses[crop]['raw_response']
        
        # Fallback response
        return """
        Risk Assessment:
        ‚Ä¢ Weather risks: Monitor local conditions
        ‚Ä¢ Storage risks: Use proper containers
        
        Timing Optimization:
        ‚Ä¢ Harvest at optimal maturity
        ‚Ä¢ Avoid adverse weather conditions
        
        Quality Enhancement:
        ‚Ä¢ Handle crops carefully
        ‚Ä¢ Maintain proper drying conditions
        """


async def demo_ai_harvest_enhancement():
    """Demonstrate the AI-enhanced harvest advisor."""
    print("üöÄ AI-Enhanced Harvest Advisor Demo")
    print("=" * 60)
    
    # Initialize mock advisor
    advisor = MockAIHarvestAdvisor()
    handler = HarvestHandler()
    
    # Replace handler's advisor with mock version
    handler.harvest_advisor = advisor
    
    # Demo cases
    demo_cases = [
        {
            'crop': 'maize',
            'location': '-13.9833, 33.7833',
            'user_id': 'demo_user_001',
            'description': 'Maize harvest in Lilongwe area'
        },
        {
            'crop': 'beans',
            'location': 'Lilongwe',
            'user_id': 'demo_user_002',
            'description': 'Bean harvest in Lilongwe'
        },
        {
            'crop': 'groundnuts',
            'location': '-13.9833, 33.7833',
            'user_id': 'demo_user_003',
            'description': 'Groundnut harvest in Lilongwe area'
        }
    ]
    
    for i, demo_case in enumerate(demo_cases, 1):
        print(f"\nüéØ Demo {i}: {demo_case['description']}")
        print("=" * 50)
        
        try:
            # Get AI-enhanced advice
            print(f"üìã Generating AI-enhanced harvest advice for {demo_case['crop']}...")
            advice = await advisor.get_harvest_advice(
                demo_case['crop'],
                demo_case['location'],
                demo_case['user_id']
            )
            
            # Check AI enhancement
            if advice.get('ai_enhanced'):
                print("‚úÖ AI Enhancement: Successful")
                
                # Show AI insights
                ai_insights = advice.get('ai_insights', {})
                if ai_insights.get('raw_response'):
                    print(f"ü§ñ AI Analysis: {len(ai_insights['raw_response'])} characters")
                
                # Show personalized recommendations
                personalized = advice.get('personalized_recommendations', [])
                print(f"üéØ Personalized Recommendations: {len(personalized)} items")
                
                # Show risk assessment
                risk_assessment = advice.get('risk_assessment', {})
                if risk_assessment.get('overall_risk_level'):
                    print(f"‚ö†Ô∏è Overall Risk: {risk_assessment['overall_risk_level']}")
                
            else:
                print(f"‚ùå AI Enhancement: Failed - {advice.get('ai_error', 'Unknown error')}")
            
            # Format and display response
            print(f"\nüìÑ AI-Enhanced Harvest Advice:")
            print("-" * 40)
            formatted_response = advisor.format_harvest_advice(advice)
            print(formatted_response)
            
            # Test handler
            print(f"\nüì± Testing Handler Integration:")
            print("-" * 40)
            command = f"/harvest {demo_case['crop']} {demo_case['location']}"
            response = await handler.handle_harvest_command(command, demo_case['user_id'])
            
            if "AI-Enhanced Analysis" in response:
                print("‚úÖ Handler AI Integration: Successful")
            else:
                print("‚ùå Handler AI Integration: Missing")
            
        except Exception as e:
            print(f"‚ùå Demo failed: {str(e)}")
            logger.error(f"Demo {i} failed: {str(e)}")
    
    print(f"\nüéâ AI Enhancement Demo Complete!")
    print("=" * 60)


def main():
    """Run the AI enhancement demo."""
    print("üöÄ Starting AI-Enhanced Harvest Advisor Demo")
    print("=" * 60)
    
    try:
        # Run demo
        asyncio.run(demo_ai_harvest_enhancement())
        
        print("\nüéØ Demo Completed Successfully!")
        print("\nüí° Key Features Demonstrated:")
        print("   ‚Ä¢ AI-powered risk assessment")
        print("   ‚Ä¢ Personalized recommendations")
        print("   ‚Ä¢ Enhanced timing optimization")
        print("   ‚Ä¢ Quality enhancement strategies")
        print("   ‚Ä¢ Market timing advice")
        print("   ‚Ä¢ Resource optimization")
        
    except Exception as e:
        print(f"\n‚ùå Demo Failed: {str(e)}")
        logger.error(f"Demo failed: {str(e)}")
        return 1
    
    return 0


if __name__ == "__main__":
    exit(main()) 